(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[808],{3905:function(e,t,a){"use strict";a.d(t,{Zo:function(){return p},kt:function(){return m}});var o=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=o.createContext({}),c=function(e){var t=o.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(a),m=n,h=d["".concat(s,".").concat(m)]||d[m]||u[m]||r;return a?o.createElement(h,i(i({ref:t},p),{},{components:a})):o.createElement(h,i({ref:t},p))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,i=new Array(r);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:n,i[1]=l;for(var c=2;c<r;c++)i[c]=a[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,a)}d.displayName="MDXCreateElement"},7871:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return l},metadata:function(){return s},toc:function(){return c},default:function(){return u}});var o=a(2122),n=a(9756),r=(a(7294),a(3905)),i=["components"],l={title:"\ud83d\ude80 Deploy on Azure",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Deploy on Azure",description:"Instructions to deploy the Notification Service for Moodle on Azure",keywords:["moodle","notification","service","deploy","azure"]},s={unversionedId:"getting-started/deploy-on-azure",id:"getting-started/deploy-on-azure",isDocsHomePage:!1,title:"\ud83d\ude80 Deploy on Azure",description:"Instructions to deploy the Notification Service for Moodle on Azure",source:"@site/moodlebot/getting-started/deploy-on-azure.md",sourceDirName:"getting-started",slug:"/getting-started/deploy-on-azure",permalink:"/moodle-notification-service/2.0.0/getting-started/deploy-on-azure",editUrl:"https://github.com/tjarbo/documentation/tree/master/docs/moodlebot/moodlebot/getting-started/deploy-on-azure.md",version:"current",sidebar_label:"Deploy on Azure",frontMatter:{title:"\ud83d\ude80 Deploy on Azure",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Deploy on Azure",description:"Instructions to deploy the Notification Service for Moodle on Azure",keywords:["moodle","notification","service","deploy","azure"]},sidebar:"tutorialSidebar",previous:{title:"\ud83d\ude80 Deploy to Heroku",permalink:"/moodle-notification-service/2.0.0/getting-started/deploy-to-heroku"},next:{title:"\ud83d\udd27 What is inside .env ?",permalink:"/moodle-notification-service/2.0.0/advanced-guides/what-is-inside-env"}},c=[{value:"\ud83d\udda5\ufe0f Deploy as VM",id:"\ufe0f-deploy-as-vm",children:[]},{value:"\ud83c\udd99 Deploy as App Service",id:"-deploy-as-app-service",children:[]},{value:"\u2705 Yeah!",id:"-yeah",children:[]},{value:"\ud83d\udcdc Access logs",id:"-access-logs",children:[]}],p={toc:c};function u(e){var t=e.components,a=(0,n.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This article will help you to deploy your notification service to Azure. You can choose between the standard approach using a ",(0,r.kt)("em",{parentName:"p"},"VM which is managed by yourself")," or to use an ",(0,r.kt)("em",{parentName:"p"},"App Service")," which manages everything for you. But this comes with a higher price.\nPlease follow the instructions step by step."),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Azure provides free credits for students. More information ",(0,r.kt)("a",{parentName:"p",href:"https://azure.microsoft.com/en-us/free/students/"},"here")))),(0,r.kt)("h3",{id:"\ufe0f-deploy-as-vm"},"\ud83d\udda5\ufe0f Deploy as VM"),(0,r.kt)("p",null,"To deploy the notification service in VM on Azure, make sure that you have ..."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"an account on ",(0,r.kt)("a",{parentName:"li",href:"https://portal.azure.com"},"Azure")," and an active subscription."),(0,r.kt)("li",{parentName:"ol"},"access to ",(0,r.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/azure/cloud-shell/quickstart"},"Azure Cloud Shell"))),(0,r.kt)("p",null,"Afterwards I refer to ",(0,r.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/azure/virtual-machines/linux/quick-create-portal"},"this article")," by Microsoft docs to setup a new Linux VM to avoid outdated information.\nYou can stop as soon as you have shell access to your VM via SSH; You do not need to install a web server."),(0,r.kt)("p",null,"Then you can continue at the beginning of ",(0,r.kt)("a",{parentName:"p",href:"/moodle-notification-service/2.0.0/getting-started/deploy-with-docker"},"Deploy-with-Docker"),"."),(0,r.kt)("h3",{id:"-deploy-as-app-service"},"\ud83c\udd99 Deploy as App Service"),(0,r.kt)("p",null,"To deploy the notification service as App Service make sure that you have ..."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"an account on ",(0,r.kt)("a",{parentName:"li",href:"https://portal.azure.com"},"Azure")," and an active subscription."),(0,r.kt)("li",{parentName:"ol"},"access to ",(0,r.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/azure/cloud-shell/quickstart"},"Azure Cloud Shell")," or to a ",(0,r.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/cli/azure/get-started-with-azure-cli"},"working az cli")),(0,r.kt)("li",{parentName:"ol"},"a ",(0,r.kt)("inlineCode",{parentName:"li"},".env")," file from ",(0,r.kt)("a",{parentName:"li",href:"/moodle-notification-service/2.0.0/getting-started/preparation"},"these steps")),(0,r.kt)("li",{parentName:"ol"},"access to a MongoDB database like from ",(0,r.kt)("a",{parentName:"li",href:"/moodle-notification-service/2.0.0/advanced-guides/use-mongodb-atlas"},"MongoDB Atlas"))),(0,r.kt)("p",null,"Open the ",(0,r.kt)("em",{parentName:"p"},"Azure Cloud Shell")," and you are ready"),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Docker has changed its rate limits on unauthenticated pull requests from Docker Hub. This can cause issues while using Docker Hub and Azure App Services. More information and a solution you can find ",(0,r.kt)("a",{parentName:"p",href:"https://azure.github.io/AppService/2020/10/15/Docker-Hub-authenticated-pulls-on-App-Service.html"},"here"),"."))),(0,r.kt)("h4",{id:"1-get-your-wanted-location-and-create-new-resource-group"},"1. Get your wanted location and create new Resource Group"),(0,r.kt)("p",null,"If you not already have, set your default subscription."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-azurecli"},"az account set --subscription XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n")),(0,r.kt)("p",null,"Receive a list of all available locations with ",(0,r.kt)("inlineCode",{parentName:"p"},"az account list-locations")," and choose your favorite location. Then use the following command to create a new resource group, replace ",(0,r.kt)("inlineCode",{parentName:"p"},"westus")," with your selected location."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-azurecli"},"az group create --name notification-service-rg --location westus\naz config set defaults.group=notification-service-rg defaults.location=westus\n")),(0,r.kt)("p",null,"The second command is used to set the default resource group and location. Please keep in mind that you need to changes these values if you are using the Azure CLI also for other projects."),(0,r.kt)("h4",{id:"2-create-an-app-service-plan"},"2. Create an App Service Plan"),(0,r.kt)("p",null,"An ",(0,r.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/azure/app-service/overview-hosting-plans"},"Azure App Service plan")," can be described as the plan for the infrastructure your Azure App Service will use. So it will define your monthly costs. There are many different plans available - for this tutorial, we have chosen the ",(0,r.kt)("em",{parentName:"p"},"B1")," SKU. Feel free to change it for your needs."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-azurecli"},"az appservice plan create -n notification-service-asp --is-linux --sku B1\n")),(0,r.kt)("h4",{id:"3-create-an-app-service"},"3. Create an App Service"),(0,r.kt)("p",null,"Choose a cool app name for the notification service. The name will be used for the final url ",(0,r.kt)("inlineCode",{parentName:"p"},"https://[app name].azurewebsites.net"),". Use this URL for the ",(0,r.kt)("inlineCode",{parentName:"p"},"RP_ORIGIN")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"RP_ID")," in your ",(0,r.kt)("inlineCode",{parentName:"p"},".env")," (e.g ",(0,r.kt)("inlineCode",{parentName:"p"},"RP_ORIGIN=https://notification-service.azurewebsites.net"),"). Replace ",(0,r.kt)("inlineCode",{parentName:"p"},"APP_NAME")," in every following command with your chosen name."),(0,r.kt)("p",null,"To create the app service and set the docker image, use the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-azurecli"},"az webapp create -p notification-service-asp -i registry.hub.docker.com/tjarbo/notification-service:next -n APP_NAME\n")),(0,r.kt)("p",null,"Next step is to apply the environment variables. Therefore you have two options. Before you continue, make sure that your ",(0,r.kt)("inlineCode",{parentName:"p"},".env")," values does not contain any whitespace or special characters like ",(0,r.kt)("inlineCode",{parentName:"p"},"$"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"()")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"#"),"."),(0,r.kt)("p",null,"If your file is located in your working directory in your ",(0,r.kt)("em",{parentName:"p"},"Azure Cloud Shell")," you can execute the next command as the first option (",(0,r.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/cloud-shell/persisting-shell-storage#how-cloud-shell-storage-works"},"How Cloud Shell storage works")," and ",(0,r.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/cloud-shell/persisting-shell-storage#transfer-local-files-to-cloud-shell"},"Transfer local files to Cloud Shell"),"):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-azurecli"},"az webapp config appsettings set --settings $(<.env) -n APP_NAME\n")),(0,r.kt)("p",null,"If not, it becomes a bit more work, as you need to apply each line of ",(0,r.kt)("inlineCode",{parentName:"p"},".env")," to the following command (KEY=value pairs are separated by a whitespace)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-azurecli"},"az webapp config appsettings set -n APP_NAME --settings MONGO_HOST=mongodb://mongo:27017/fmdb MOODLE_BASE_URL=https://moodle...\n")),(0,r.kt)("p",null,"Validate the output that every variable has been set correctly. Additional variables displayed like ",(0,r.kt)("inlineCode",{parentName:"p"},"DOCKER_REGISTRY_SERVER_URL")," just ignore them."),(0,r.kt)("p",null,"To know, whats going on with your Notification Service, use the following command to active the logging. You will need the logs to get your registration token."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-azurecli"},"az webapp log config --application-logging filesystem --docker-container-logging filesystem --web-server-logging off -n APP_NAME\n")),(0,r.kt)("h3",{id:"-yeah"},"\u2705 Yeah!"),(0,r.kt)("p",null,"Wow, you have successfully deploy your own Notification Service on Azure! Now you are ready to get started. ",(0,r.kt)("strong",{parentName:"p"},"Open the web interface to trigger the initialization process")," with ",(0,r.kt)("inlineCode",{parentName:"p"},"az webapp browse --name APP_NAME")," and then use the commands from the ",(0,r.kt)("a",{parentName:"p",href:"#-access-logs"},"next section")," to open the logs and get your registration token!"),(0,r.kt)("h3",{id:"-access-logs"},"\ud83d\udcdc Access logs"),(0,r.kt)("p",null,"You can either access the logs via ",(0,r.kt)("inlineCode",{parentName:"p"},"portal.azure.com")," -> Open the new app service -> ",(0,r.kt)("em",{parentName:"p"},"Log stream")," or by using the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-azurecli"},"az webapp log tail -n APP_NAME\n")))}u.isMDXComponent=!0}}]);